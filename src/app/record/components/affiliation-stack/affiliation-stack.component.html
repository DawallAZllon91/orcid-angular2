<!-- A single affiliation
That might have N equivalent affiliations with with different sources  -->

<ng-container
  *ngFor="
    let affiliation of affiliationStack.affiliations;
    let i = index;
    let last = last;
    trackBy: trackByAffiliationStack
  "
>
  <app-panel
    [elements]="affiliation"
    [ngStyle]="{ 'z-index': affiliationStack.affiliations.length - i }"
    [ngClass]="{ 'stack-mode': !last && stackMode}"
    [visibility]="affiliationStack.defaultAffiliation.visibility.visibility"
    *ngIf="isPreferred(affiliation) || stackMode"
    type="main"
  >
    <h2 header class="orc-font-body" i18n="@@record.emails">
      {{ affiliation.affiliationName.value }}:

      <ng-container *ngIf="affiliation.city.value">
        {{ affiliation.city.value }},
      </ng-container>
      <ng-container *ngIf="affiliation.region.value">
        {{ affiliation.region.value }},
      </ng-container>
      <ng-container *ngIf="affiliation.country.value">
        {{ affiliation.country.value }}
      </ng-container>
    </h2>

    <app-affiliation
      *ngIf="stackCardsState[affiliation.putCode.value].stackState"
      [affiliation]="affiliation"
      [affiliationDetailsState]="
        affiliationDetailsState[affiliation.putCode.value]
      "
      (toggleDetails)="toggleDetails($event)"
      [orgDisambiguated]="orgDisambiguated[affiliation.putCode.value]"
    >
    </app-affiliation>
    <app-panel-source
      [isPreferred]="isPreferred(affiliation)"
      [sourceName]="affiliation.sourceName || affiliation.source"
      [stackLength]="affiliationStack.affiliations.length"
      [(stackMode)]="stackMode"
      (makePrimary)="makePrimaryCard($event)"
      [displayAsMainStackCard]="
        stackCardsState[affiliation.putCode.value].stackState
      "
      (displayAsMainStackCardChange)="changeStackDisplayedCard(affiliation)"
    >
    </app-panel-source>
  </app-panel>
</ng-container>
