<ng-container *ngFor="let work of workStack.works; trackBy: trackByWorkStack">
  <!-- A PANEL COMPONENT FOR EACH AFFILIATION ON THE STACK -->
  <app-panel
    [elements]="work"
    [ngStyle]="{ 'z-index': affiliationStack.affiliations.length - i }"
    [ngClass]="{ last: last }"
    [visibility]="affiliationStack.defaultAffiliation.visibility.visibility"
    *ngIf="isPreferred(work) || displayTheStack"
    type="main"
  >
    <h2 header class="orc-font-body" i18n="@@record.emails">
      {{ affiliation.affiliationName.value }}:

      <ng-container *ngIf="affiliation.city.value">
        {{ affiliation.city.value }},
      </ng-container>
      <ng-container *ngIf="affiliation.region.value">
        {{ affiliation.region.value }},
      </ng-container>
      <ng-container *ngIf="affiliation.country.value">
        {{ affiliation.country.value }}
      </ng-container>
    </h2>
    <!-- AFFILIATION BODY -->
    <app-work
      *ngIf="stackPanelsDisplay[affiliation.putCode.value].topPanelOfTheStack"
      [affiliation]="affiliation"
      [panelDetailsState]="panelDetailsState[affiliation.putCode.value]"
      (toggleDetails)="toggleDetails($event)"
      [orgDisambiguated]="orgDisambiguated[affiliation.putCode.value]"
    >
    </app-work>
    <!-- AFFILIATION SOURCE -->
    <app-panel-source
      [isPreferred]="isPreferred(affiliation)"
      [sourceName]="affiliation.sourceName || affiliation.source"
      [stackLength]="affiliationStack.affiliations.length"
      [(displayTheStack)]="displayTheStack"
      (makePrimary)="makePrimaryCard($event)"
      [topPanelOfTheStackMode]="
        stackPanelsDisplay[affiliation.putCode.value].topPanelOfTheStack
      "
      (topPanelOfTheStackModeChange)="changeTopPanelOfTheStack(affiliation)"
    >
    </app-panel-source>
  </app-panel>
</ng-container>
